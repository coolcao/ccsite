---
title: ä½¿ç”¨FFMPEGåšä¸€äº›æœ‰æ„æ€çš„æ¨æµç›´æ’­
date: 2024-02-22 08:57:41
tags: [ffmpeg, æ¨æµ, ç›´æ’­]
categories:
- æŠ€æœ¯åšå®¢
- åŸåˆ›
---

ç°åœ¨çš„ç›´æ’­ï¼Œå¤§ä½“åˆ†ä¸¤ç§åœºæ™¯ï¼Œä¸€æ˜¯äººç«™åœ¨æ‘„åƒå¤´å‰ç›´æ’­ï¼Œè¿˜æœ‰ä¸€ç§æ˜¯ä½¿ç”¨æ¨æµè½¯ä»¶ï¼Œå°†è§†é¢‘ï¼ŒéŸ³ä¹ï¼Œå›¾ç‰‡ç­‰è¿›è¡Œæ¨æµç›´æ’­ã€‚
ç¬¬ä¸€ç§åœºæ™¯éœ€è¦æœ‰äººä¸€ç›´åœ¨é•œå¤´å‰è¿›è¡Œç›´æ’­ï¼Œè€Œç¬¬äºŒç§æ–¹å¼ï¼Œæ¨æµçš„æ˜¯é™æ€èµ„æºï¼Œè§†é¢‘ï¼ŒéŸ³ä¹ï¼Œå›¾ç‰‡ç­‰éƒ½æ˜¯å›ºå®šçš„èµ„æºï¼Œåªæ˜¯ä¸åœçš„è½®æ’­è€Œå·²ã€‚
é‚£æœ‰æ²¡æœ‰ä¸€ç§æ–¹å¼ï¼Œæ—¢å¯ä»¥æ— äººå®ˆæŠ¤ï¼Œåˆå¯ä»¥æ¨æµåŠ¨æ€èµ„æºå‘¢ï¼Ÿ

<!-- more -->
ä»Šå¤©å°±ä»‹ç»ä¸€ä¸‹æˆ‘æ¢ç´¢å‡ºæ¥çš„ä¸€ç§æ–¹æ³•ï¼Œä½¿ç”¨ffmpegæ¨æµåŠ¨æ€èµ„æºçš„æ–¹æ³•ã€‚
å…¶å®åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å°†åŠ¨æ€èµ„æºåšæˆç½‘é¡µèµ„æºï¼Œç„¶åä½¿ç”¨æµè§ˆå™¨è®¿é—®è¯¥èµ„æºæ˜¾ç¤ºï¼Œæœ€åä½¿ç”¨ffmpegå°†æµè§ˆå™¨æ¨æµå‡ºæ¥å³å¯ã€‚
æ­¤æ–¹æ³•éœ€è¦æœ‰ç¼–ç¨‹åŸºç¡€ï¼ŒåšåŠ¨æ€ç½‘é¡µï¼Œå®‰è£…æ‰€éœ€è½¯ä»¶ç­‰ã€‚

## ç¯å¢ƒæ­å»º
é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦ä¸€å°æœåŠ¡å™¨ï¼Œvpsï¼Œæˆ–è€…ç§äººå°ä¸»æœºéƒ½å¯ä»¥ï¼Œä¸éœ€è¦å…¬ç½‘ipï¼Œä½†éœ€è¦ä¸€ç›´å¼€æœºè¿›è¡Œæ¨æµç›´æ’­ã€‚

ç„¶ååœ¨vpsä¸Šå®‰è£…ä¸‹é¢æ‰€éœ€è½¯ä»¶ï¼š


|è½¯ä»¶åç§°|	å®‰è£…å‘½ä»¤|	å¤‡æ³¨|
|----|----|----|
|ffmpeg|	apt install ffmpeg|	ç›´æ’­æ¨æµè½¯ä»¶|
|xvfb|	apt install xvfb|	xvfbè™šæ‹Ÿæ¡Œé¢è½¯ä»¶ï¼Œç”¨ä»¥è¿è¡Œæµè§ˆå™¨|
|chromium|	apt install chromium|	chromeæµè§ˆå™¨å¼€æºç‰ˆæœ¬ï¼Œå±•ç¤ºç½‘é¡µåŠ¨æ€æ•°æ®|
|fonts-wqy-zenhei|	apt install fonts-wqy-zenhei|	å¼€æºå­—ä½“ï¼Œå¦‚æœä¸å®‰è£…ä¸­æ–‡å­—ä½“ï¼Œæµè§ˆå™¨ä¸­æ–‡ä¹±ç |
|tmux|	apt install tmux|	ç»ˆç«¯å¤ç”¨å·¥å…·ï¼Œå¯ä»¥ä¿æŒä¼šè¯ä¸é€€å‡º|

> ä»¥ä¸Šè½¯ä»¶ä¸ºåœ¨ ubuntu linux ä¸Šçš„å®‰è£…ç¤ºä¾‹å‘½ä»¤ï¼Œå…¶ä»–linuxå¯ä»¥ä¸Šç½‘æŸ¥é˜…ç›¸å…³å‘½ä»¤ã€‚


## åŠ¨æ€ç½‘é¡µåˆ¶ä½œ
è¿™ä¸€æ­¥å°±æ˜¯å¼€å‘ä¸€å¥—ç½‘é¡µç³»ç»Ÿï¼Œç”¨ä»¥æ˜¾ç¤ºéœ€è¦åŠ¨æ€å±•ç¤ºå†…å®¹çš„webé¡µé¢ï¼Œè¿™é‡Œå¯ä»¥æ ¹æ®éœ€è¦è‡ªè¡Œå¼€å‘ï¼Œå¯ä»¥ç®€å•åˆ°åªæœ‰ä¸€ä¸ªé™æ€webé¡µï¼Œä¹Ÿå¯ä»¥å¤æ‚åˆ°å‰ç«¯web+åç«¯æ¥å£ç³»ç»Ÿè¿™ç§webç³»ç»Ÿã€‚

è¿™é‡Œç®€å•èµ·è§ï¼Œæˆ‘åªæ­å»ºä¸€ä¸ªç®€å•åœ°å‰ç«¯é¡µé¢ï¼Œç”¨ä»¥æ˜¾ç¤ºå½“å‰æ—¶é—´ã€‚å¤§ä½“æ˜¾ç¤ºæ•ˆæœå¦‚ä¸‹ï¼š
![](https://img.coolcao.site/file/8d945bd6f2505f7eaa2c5.png)


## å…³é—­é˜²ç«å¢™
é¦–å…ˆï¼ŒæŸ¥çœ‹é˜²ç«å¢™çŠ¶æ€ï¼š

```bash
ufw status

Status: active

To                         Action      From
--                         ------      ----
22/tcp                     ALLOW       Anywhere
22/tcp (v6)                ALLOW       Anywhere (v6)
```

è¯´æ˜é˜²ç«å¢™æ˜¯å¼€å¯çš„ã€‚

å¯ä»¥ä½¿ç”¨ `ufw disable` å…³é—­


## xvfbå¯åŠ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨
```
Xvfb :99 -screen 0 1920x1080x24
```

ä»¥ä¸Šå‘½ä»¤å¯åŠ¨ä¸€ä¸ªåˆ†è¾¨ç‡ä¸º 1920*1080 åˆ·æ–°ç‡ 24Hzçš„è™šæ‹Ÿæ˜¾ç¤ºå™¨ï¼Œç”¨ä»¥æ”¯æŒæµè§ˆå™¨chromeå±•ç¤ºé¡µé¢ã€‚


## è¿è¡Œæµè§ˆå™¨
```
DISPLAY=:99 chromium 127.0.0.1:4200/clock --user-data-dir=/root/chrome-profile --no-sandbox --disable-gpu --disable-remote-fonts --disable-features=RendererCodeIntegrity --remote-debugging-port=9222 --incognito  --kiosk --window-size=1920,1080 --start-fullscreen
```

ä»¥ä¸Šå‘½ä»¤åœ¨è™šæ‹Ÿæ˜¾ç¤ºå™¨ä¸Šè¿è¡Œchromiumæµè§ˆå™¨ï¼Œå¹¶æ‰“å¼€ç½‘é¡µ `127.0.0.1:4200/clock` ã€‚

è¿™é‡Œä½¿ç”¨ `â€”no-sandbox` å’Œ `â€”disable-gpu` å‚æ•°æ¥ç¦ç”¨æ²™ç®±å’ŒGPUåŠ é€Ÿï¼Œå› ä¸ºåœ¨æ²¡æœ‰æ¡Œé¢ç¯å¢ƒçš„æœåŠ¡å™¨ä¸Šè¿è¡Œchromiumæ—¶ï¼Œè¿™äº›åŠŸèƒ½æ— æ³•æ­£å¸¸å·¥ä½œã€‚

`--incognito` å‚æ•°å¼€å¯æ— ç—•æ¨¡å¼ã€‚

`--kiosk` å‚æ•°å¼€å¯chromiumæ¼”ç¤ºæ¨¡å¼ï¼Œå³å…¨å±æ˜¾ç¤º

`--window-size=1920,1080` æŒ‡å®šæµè§ˆå™¨å¯åŠ¨åçª—å£å¤§å°ä¸º 1920*1080ï¼Œå³å’Œå±å¹•å¤§å°ä¸€è‡´

> ğŸ’¡ æ—¢ç„¶å·²ç»æ˜¯å…¨å±è¿è¡Œchromiumï¼Œä¸ºå•¥è¿˜è¦æŒ‡å®š window-size å‚æ•°ï¼Ÿ
> Xvfb åªæä¾›äº†è™šæ‹Ÿçš„æ˜¾ç¤ºå±ï¼Œä¸ä¼šå½±å“å®é™…çš„æ˜¾ç¤ºè®¾ç½®æˆ–ç‰©ç†æ˜¾ç¤ºè®¾å¤‡ã€‚å¯¹äºæµè§ˆå™¨å…¨å±æ˜¾ç¤ºçš„é—®é¢˜ï¼Œä»ç„¶éœ€è¦æ£€æŸ¥æ“ä½œç³»ç»Ÿã€æµè§ˆå™¨è®¾ç½®ä»¥åŠå…¶ä»–ç›¸å…³å› ç´ ï¼Œä»¥ç¡®ä¿æµè§ˆå™¨åœ¨å…¨å±æ¨¡å¼ä¸‹ä½¿ç”¨æ‰€éœ€çš„åˆ†è¾¨ç‡ã€‚


> ğŸ’¡ å¦‚æœå¯åŠ¨æµè§ˆå™¨æ—¶éœ€è¦é»‘è‰²æ¨¡å¼ï¼Œåˆ™ç›´æ¥åœ¨å¯åŠ¨å‘½ä»¤åæ·»åŠ  `--force-dark-mode` ï¼Œå³æœ€ç»ˆå‘½ä»¤å¦‚ä¸‹ï¼š
>`DISPLAY=:99 /usr/bin/google-chrome --force-dark-mode https://cn.piliapp.com/time/?theme=flip --user-data-dir=/root/chrome-profile --no-sandbox --disable-gpu --disable-remote-fonts --disable-features=RendererCodeIntegrity --remote-debugging-port=9222 --incognito  --kiosk --window-size=1920,1080 --start-fullscreen`


## ä½¿ç”¨ffmpegè¿›è¡Œæ¨æµ
```
ffmpeg -f x11grab -video_size 1920x1080 -draw_mouse 0  -i :99 -stream_loop -1 -i /root/tuesday.mp3 -c:v libx264 -c:a aac -preset ultrafast -qp 0 -shortest -f flv "rtmp://ç›´æ’­é“¾æ¥"
```

å‚æ•°è¯´æ˜ï¼š

- `-video_size 1920x1080` æŒ‡å®šæ¨æµè§†é¢‘å¤§å°ä¸º 1920x1080ï¼Œç»æµ‹è¯•åœ¨xvfbè™šæ‹Ÿæ˜¾ç¤ºå™¨ä¸Šåˆ†è¾¨ç‡è¿™æ ·ï¼Œå…·ä½“å¦‚ä½•ä¿®æ”¹æ›´å¤§åˆ†è¾¨ç‡æš‚æ—¶è¿˜æœªæ‰¾åˆ°æ–¹æ³•
- `-draw_mouse 0` è¯¥å‚æ•°æŒ‡å®šä¸æ˜¾ç¤ºé¼ æ ‡æŒ‡é’ˆ
- `-i :99` æŒ‡å®šè¾“å…¥ä¸º `:99` çš„xvfbå¼€å¯çš„è™šæ‹Ÿæ˜¾ç¤ºå™¨ä¸Šã€‚è¿™ä¸ª `:99` å³æ˜¯ä¸Šé¢ `Xvfb :99 -screen 0 1920x1080x24` æŒ‡å®šçš„è™šæ‹Ÿæ˜¾ç¤ºå™¨ç¼–å·
- `-stream_loop -1` æŒ‡å®šç›´æ’­æµä¸€ç›´å¾ªç¯
- `-i /root/tuesday.mp3` æŒ‡å®šæ¨æµèƒŒæ™¯éŸ³ä¹
- `-c:v libx264` æŒ‡å®šè§†é¢‘ç¼–ç 
- `-c:a aac` æŒ‡å®šéŸ³é¢‘ç¼–ç 




